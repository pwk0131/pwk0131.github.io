<!-- Switch the mode between dark and light. -->

<!-- Switch the mode between dark and light. -->

<script type="text/javascript">
  class ModeToggle {
    static get MODE_KEY() {
      return 'mode';
    }
    static get MODE_ATTR() {
      return 'data-mode';
    }
    static get DARK_MODE() {
      return 'dark';
    }
    static get LIGHT_MODE() {
      return 'light';
    }
    static get ID() {
      return 'mode-toggle';
    }

    constructor() {
      // 1. 페이지 로드 시 sessionStorage 값을 무조건 적용합니다.
      if (this.isDarkMode) {
        this.setDark();
      } else if (this.isLightMode) {
        this.setLight();
      }

      let self = this;

      this.sysDarkPrefers.addEventListener('change', () => {
        // 사용자가 직접 모드를 선택한 경우(sessionStorage에 값이 있는 경우)에는
        // 시스템 설정 변경을 무시합니다.
        if (self.hasMode) {
          return;
        }

        // 사용자가 선택하지 않았을 때만 시스템 설정을 따릅니다.
        self.notify();
      });
    }

    get sysDarkPrefers() {
      return window.matchMedia('(prefers-color-scheme: dark)');
    }

    get isSysDarkPrefer() {
      return this.sysDarkPrefers.matches;
    }

    get isDarkMode() {
      return this.mode === ModeToggle.DARK_MODE;
    }

    get isLightMode() {
      return this.mode === ModeToggle.LIGHT_MODE;
    }

    get hasMode() {
      return this.mode != null;
    }

    get mode() {
      return sessionStorage.getItem(ModeToggle.MODE_KEY);
    }

    get modeStatus() {
      const mode = document.documentElement.getAttribute(ModeToggle.MODE_ATTR);
      return mode ? mode : (this.isSysDarkPrefer ? ModeToggle.DARK_MODE : ModeToggle.LIGHT_MODE);
    }

    setDark() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE);
    }

    setLight() {
      document.documentElement.setAttribute(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE);
      sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE);
    }

    clearMode() {
      document.documentElement.removeAttribute(ModeToggle.MODE_ATTR);
      sessionStorage.removeItem(ModeToggle.MODE_KEY);
    }

    notify() {
      window.postMessage(
        {
          direction: ModeToggle.ID,
          message: this.modeStatus
        },
        '*'
      );
    }

    // 2. 버튼 클릭 시 시스템 설정과 상관없이 무조건 라이트/다크를 전환합니다.
    flipMode() {
      if (this.modeStatus === ModeToggle.DARK_MODE) {
        this.setLight();
      } else {
        this.setDark();
      }
      this.notify();
    }
  }

  const modeToggle = new ModeToggle();
</script>